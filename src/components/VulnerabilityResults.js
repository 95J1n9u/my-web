import React, { useState } from 'react';
import analysisService from '../services/analysisService';
import { sanitizeHtml, sanitizeText } from '../utils/sanitizer';
import { authService } from '../config/firebase';
import AIRemediation from './AIRemediation';
import ComplianceDashboard from './ComplianceDashboard';


const VulnerabilityResults = ({
  results,
  comparisonResults,
  isAnalyzing,
  error,
  selectedFramework,
  frameworks,
  onRetry,
  onReset,
  user,
  isHistorical = false,
  originalConfigText = '',
}) => {
  const [selectedSeverity, setSelectedSeverity] = useState('ì „ì²´');
  const [expandedCard, setExpandedCard] = useState(null);
  const [viewMode, setViewMode] = useState('single');
  const [selectedComparisonFramework, setSelectedComparisonFramework] = useState(null);
  const [selectedResultTab, setSelectedResultTab] = useState('failed'); // ìƒˆë¡œ ì¶”ê°€
  const [aiResults, setAiResults] = useState(null);
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiError, setAiError] = useState(null);
  const [showAiRemediation, setShowAiRemediation] = useState(false);
  const [aiUsageInfo, setAiUsageInfo] = useState(null);
  const [loadingUsageInfo, setLoadingUsageInfo] = useState(false);
  const [aiJobId, setAiJobId] = useState(null);
const [aiStreamingProgress, setAiStreamingProgress] = useState(null);
const [jobMonitoringInterval, setJobMonitoringInterval] = useState(null);

  

  // ë¹„êµ ëª¨ë“œ ì´ˆê¸°í™”
  React.useEffect(() => {
    if (comparisonResults) {
      setViewMode('comparison');
      const firstFramework = Object.keys(comparisonResults.frameworks)[0];
      setSelectedComparisonFramework(firstFramework);
    } else if (results) {
      setViewMode('single');
    }
  }, [comparisonResults, results]);

  // í˜„ì¬ í‘œì‹œí•  ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
  const getCurrentDisplayResults = () => {
    if (viewMode === 'comparison' && comparisonResults) {
      const frameworkResult =
        comparisonResults.frameworks[selectedComparisonFramework];
      return frameworkResult && !frameworkResult.error ? frameworkResult : null;
    }
    return results;
  };

  const currentResults = getCurrentDisplayResults();

      React.useEffect(() => {
    const loadAIUsageInfo = async () => {
      if (!user?.uid || !currentResults?.vulnerabilities?.length || isHistorical) return;
      
      try {
        const result = await authService.checkAIUsageLimit(user.uid);
        if (result.success) {
          setAiUsageInfo(result);
        }
      } catch (error) {
        console.error('Failed to load AI usage info:', error);
      }
    };

    loadAIUsageInfo();
  }, [user?.uid, currentResults?.vulnerabilities?.length, isHistorical]);

// ğŸ”¥ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
React.useEffect(() => {
  if (currentResults?.metadata?.complianceSummary) {
    console.log('ComplianceSummary:', currentResults.metadata.complianceSummary);
    console.log('SeverityBreakdown type:', typeof currentResults.metadata.complianceSummary.severityBreakdown);
    console.log('SeverityBreakdown value:', currentResults.metadata.complianceSummary.severityBreakdown);
    console.log('CategoryBreakdown type:', typeof currentResults.metadata.complianceSummary.categoryBreakdown);
    console.log('CategoryBreakdown value:', currentResults.metadata.complianceSummary.categoryBreakdown);
  }
}, [currentResults]);

// ê²°ê³¼ íƒ­ ë°ì´í„° ê³„ì‚° í•¨ìˆ˜
const getResultTabsData = () => {
  if (!currentResults) {
    return {
      failed: [],
      passed: [],
      skipped: []
    };
  }
  
  // ì•ˆì „í•œ ë°°ì—´ ë°˜í™˜ ë³´ì¥
  const failed = Array.isArray(currentResults.vulnerabilities) ? currentResults.vulnerabilities : [];
  const passed = Array.isArray(currentResults.passedRules) ? currentResults.passedRules : [];
  const skipped = Array.isArray(currentResults.skippedRules) ? currentResults.skippedRules : [];
  
  return {
    failed,
    passed,
    skipped
  };
};

// í˜„ì¬ ì„ íƒëœ íƒ­ì˜ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
const getCurrentTabResults = () => {
  const tabsData = getResultTabsData();
  const results = tabsData[selectedResultTab];
  
  // ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° ë¹ˆ ë°°ì—´ ë°˜í™˜
  return Array.isArray(results) ? results : [];
};

  // ì‹¬ê°ë„ë³„ í•„í„°ë§ í•¨ìˆ˜
  const getFilteredResults = () => {
    const currentTabResults = getCurrentTabResults();
    if (selectedSeverity === 'ì „ì²´') {
      return currentTabResults;
    }
    
    return currentTabResults.filter(item => {
      const displaySeverity = getSeverityDisplay(item.severity);
      return displaySeverity === selectedSeverity;
    });
  };

  const filteredResults = getFilteredResults();

// AI ì¡°ì¹˜ ë°©ì•ˆ í•¸ë“¤ëŸ¬ - ìë™ ëª¨ë“œ ì„ íƒ
const handleGetAIRemediation = async () => {
  if (!currentResults || !currentResults.vulnerabilities?.length) {
    alert('AI ì¡°ì¹˜ ë°©ì•ˆì„ ìƒì„±í•˜ê¸° ìœ„í•´ì„œëŠ” ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  if (!originalConfigText) {
    alert('ì›ë³¸ ì„¤ì • íŒŒì¼ ë‚´ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
    return;
  }

  // ì‚¬ìš©ì ë¡œê·¸ì¸ í™•ì¸
  if (!user?.uid) {
    alert('AI ì¡°ì¹˜ ë°©ì•ˆ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  setLoadingUsageInfo(true);

  try {
    // AI ì‚¬ìš©ëŸ‰ í•œë„ í™•ì¸ (ëª¨ë“  ëª¨ë“œì—ì„œ ë™ì¼í•˜ê²Œ ì ìš©)
    console.log('AI ì‚¬ìš©ëŸ‰ í•œë„ í™•ì¸ ì¤‘...');
    const usageResult = await authService.checkAIUsageLimit(user.uid);
    
    if (!usageResult.success) {
      throw new Error(`ì‚¬ìš©ëŸ‰ í™•ì¸ ì‹¤íŒ¨: ${usageResult.error}`);
    }

    setAiUsageInfo(usageResult);

    // ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (Enterprise ëª¨ë“œë„ ë™ì¼í•œ ì œí•œ ì ìš©)
    if (!usageResult.canUse) {
      const vulnerabilityCount = currentResults.vulnerabilities.length;
      const modeText = vulnerabilityCount >= 10 ? 'Enterprise ëª¨ë“œ' : 'ì¼ë°˜ ëª¨ë“œ';
      alert(
        `AI ì¡°ì¹˜ ë°©ì•ˆ ìƒì„± í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n` +
        `ëª¨ë“œ: ${modeText} (${vulnerabilityCount}ê°œ ì·¨ì•½ì )\n` +
        `ì˜¤ëŠ˜ ì‚¬ìš©ëŸ‰: ${usageResult.usageCount}/20íšŒ\n` +
        `ë‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”.`
      );
      return;
    }

    // ğŸ”¥ ì·¨ì•½ì  ìˆ˜ì— ë”°ë¥¸ ìë™ ëª¨ë“œ ê²°ì •
    const vulnerabilityCount = currentResults.vulnerabilities.length;
    const isEnterpriseMode = vulnerabilityCount >= 10;
    
    console.log('AI ë¶„ì„ ëª¨ë“œ ê²°ì •:', {
      vulnerabilityCount,
      mode: isEnterpriseMode ? 'Enterprise' : 'Standard',
      usageCount: usageResult.usageCount,
      remainingUsage: usageResult.remainingUsage,
      isAdmin: usageResult.isAdmin,
    });

    setLoadingUsageInfo(false);
    setIsAiLoading(true);
    setAiError(null);

    try {
      console.log('AI API ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘...');
      try {
        const healthCheck = await analysisService.checkAIApiHealth();
        console.log('AI API ì„œë²„ ìƒíƒœ:', healthCheck);
      } catch (healthError) {
        console.error('AI API ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', healthError);
        throw new Error(`AI API ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${healthError.message}`);
      }

      console.log('ë¶„ì„ ê²°ê³¼ ë³€í™˜ ì¤‘...');
      
      // ë°ì´í„° ìœ íš¨ì„± ì‚¬ì „ ê²€ì¦
      if (!currentResults) {
        throw new Error('ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ ë¶„ì„í•´ì£¼ì„¸ìš”.');
      }

      if (!originalConfigText || originalConfigText.trim().length === 0) {
        throw new Error('ì›ë³¸ ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
      }

      // ì·¨ì•½ì ì´ ì—†ëŠ” ê²½ìš°ì—ë„ AI ë¶„ì„ í—ˆìš©
      if (vulnerabilityCount === 0) {
        const confirmProceed = window.confirm(
          'ë°œê²¬ëœ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.\n' +
          'AIê°€ ì„¤ì • íŒŒì¼ì„ ê²€í† í•˜ì—¬ ì ì¬ì  ê°œì„ ì‚¬í•­ì„ ì œì•ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n' +
          'ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
        );
        
        if (!confirmProceed) {
          return;
        }
      }

      let aiFormatData;
      try {
        aiFormatData = analysisService.transformToAIFormat(currentResults, originalConfigText);
        console.log('ë°ì´í„° ë³€í™˜ ì„±ê³µ:', {
          configLength: aiFormatData.original_config.length,
          vulnerabilityCount: aiFormatData.vulnerability_report.vulnerabilities.length,
          framework: aiFormatData.vulnerability_report.metadata.framework,
          deviceType: aiFormatData.vulnerability_report.metadata.deviceType,
          mode: isEnterpriseMode ? 'Enterprise' : 'Standard'
        });
      } catch (transformError) {
        console.error('ë°ì´í„° ë³€í™˜ ì‹¤íŒ¨:', transformError);
        throw new Error(`ë°ì´í„° ë³€í™˜ ì‹¤íŒ¨: ${transformError.message}`);
      }
      
      console.log(`AI ì¡°ì¹˜ ë°©ì•ˆ ìš”ì²­ ì¤‘... (${isEnterpriseMode ? 'Enterprise' : 'Standard'} ëª¨ë“œ)`);
      
      // AI API ìš”ì²­ ì „ ìµœì¢… ê²€ì¦
      if (!aiFormatData.original_config || aiFormatData.original_config.length < 10) {
        throw new Error('ì„¤ì • íŒŒì¼ ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤.');
      }

      if (!aiFormatData.vulnerability_report || !aiFormatData.vulnerability_report.metadata) {
        throw new Error('ì·¨ì•½ì  ë³´ê³ ì„œ ë©”íƒ€ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }

      // ğŸ”¥ ëª¨ë“œë³„ ìµœì í™”ëœ AI ì˜µì…˜ ì„¤ì •
      const aiOptions = {
        batch_size: isEnterpriseMode ? (vulnerabilityCount >= 50 ? 3 : 4) : null,
        max_concurrent: isEnterpriseMode ? 3 : 2,
        enable_streaming: false // ìŠ¤íŠ¸ë¦¬ë°ì€ ë³„ë„ êµ¬í˜„ ì˜ˆì •
      };

      console.log('AI API ìš”ì²­ ì˜µì…˜:', aiOptions);

      const aiResult = await analysisService.getAIRemediation(
        aiFormatData.original_config,
        aiFormatData.vulnerability_report,
        undefined, // aiApiBaseUrl - ê¸°ë³¸ê°’ ì‚¬ìš©
        aiOptions
      );

      console.log('AI ì¡°ì¹˜ ë°©ì•ˆ ì‘ë‹µ ë°›ìŒ:', {
        mode: isEnterpriseMode ? 'Enterprise' : 'Standard',
        isAsync: aiResult.isAsync,
        jobId: aiResult.job_id,
        totalVulnerabilities: aiResult.analysis_summary?.total_vulnerabilities,
        processedSuccessfully: aiResult.analysis_summary?.processed_successfully,
        fixesCount: aiResult.vulnerability_fixes?.length
      });
      
      // ğŸ”¥ ë¹„ë™ê¸° ì²˜ë¦¬ ê²°ê³¼ì¸ ê²½ìš° (Enterprise ëª¨ë“œ)
      if (aiResult.isAsync && aiResult.job_id) {
        console.log('Enterprise ë¹„ë™ê¸° ì²˜ë¦¬ ì‹œì‘:', aiResult.job_id);
        setAiJobId(aiResult.job_id);
        setAiResults({ 
          ...aiResult,
          isAsync: true,
          mode: 'Enterprise'
        });
        
        // ì‘ì—… ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
        startJobMonitoring(aiResult.job_id);
      } else {
        // ë™ê¸° ì²˜ë¦¬ ê²°ê³¼ (Standard ëª¨ë“œ)
        console.log('Standard ë™ê¸° ì²˜ë¦¬ ì™„ë£Œ');
        setAiResults({
          ...aiResult,
          mode: 'Standard'
        });
      }
      
      // ğŸ”¥ ì„±ê³µì ìœ¼ë¡œ AI ì‘ë‹µì„ ë°›ì€ ê²½ìš°ì—ë§Œ ì‚¬ìš©ëŸ‰ ì¦ê°€ (ëª¨ë“  ëª¨ë“œ ë™ì¼)
      console.log('AI ì‚¬ìš©ëŸ‰ ì¦ê°€ ì¤‘...');
      const incrementResult = await authService.incrementAIUsage(user.uid);
      
      if (incrementResult.success) {
        console.log('AI ì‚¬ìš©ëŸ‰ ì¦ê°€ ì™„ë£Œ:', {
          mode: isEnterpriseMode ? 'Enterprise' : 'Standard',
          newUsageCount: incrementResult.usageCount,
          remainingUsage: incrementResult.remainingUsage,
        });
        
        // ì‚¬ìš©ëŸ‰ ì •ë³´ ì—…ë°ì´íŠ¸
        setAiUsageInfo(prev => ({
          ...prev,
          usageCount: incrementResult.usageCount,
          remainingUsage: incrementResult.remainingUsage,
        }));
      } else {
        console.warn('AI ì‚¬ìš©ëŸ‰ ì¦ê°€ ì‹¤íŒ¨:', incrementResult.error);
      }

      setShowAiRemediation(true);
    } catch (error) {
      console.error('AI ì¡°ì¹˜ ë°©ì•ˆ ìš”ì²­ ì‹¤íŒ¨:', error);
      setAiError(error.message);
      
      let userMessage = '';
      if (error.message.includes('ë°ì´í„° ë³€í™˜ ì‹¤íŒ¨')) {
        userMessage = `ë°ì´í„° ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}\níŒŒì¼ì„ ë‹¤ì‹œ ë¶„ì„í•´ì£¼ì„¸ìš”.`;
      } else if (error.message.includes('ë„¤íŠ¸ì›Œí¬ ì—°ê²°')) {
        userMessage = 'ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      } else if (error.message.includes('422')) {
        userMessage = 'AI ì„œë²„ì—ì„œ ë°ì´í„° í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
      } else if (error.message.includes('ë‚´ë¶€ ì˜¤ë¥˜')) {
        userMessage = 'AI ì„œë²„ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      } else {
        userMessage = `AI ìš”ì²­ ì‹¤íŒ¨: ${error.message}`;
      }
      
      const modeText = vulnerabilityCount >= 10 ? 'Enterprise' : 'Standard';
      alert(`AI ì¡°ì¹˜ ë°©ì•ˆ ìƒì„± ì‹¤íŒ¨ (${modeText} ëª¨ë“œ):\n${userMessage}`);
    } finally {
      setIsAiLoading(false);
    }
  } catch (error) {
    console.error('ì‚¬ìš©ëŸ‰ í™•ì¸ ì˜¤ë¥˜:', error);
    alert(`ì‚¬ìš©ëŸ‰ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
  } finally {
    setLoadingUsageInfo(false);
  }
};


// ğŸ”¥ ì‘ì—… ëª¨ë‹ˆí„°ë§ í•¨ìˆ˜
const startJobMonitoring = (jobId) => {
  const interval = setInterval(async () => {
    try {
      const status = await analysisService.checkJobStatus(jobId);
      console.log('ì‘ì—… ìƒíƒœ í™•ì¸:', status);
      
      if (status.status === 'completed') {
        // ì‘ì—… ì™„ë£Œ - ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
        const result = await analysisService.getJobResult(jobId);
        setAiResults(result);
        setIsAiLoading(false);
        clearInterval(interval);
        setJobMonitoringInterval(null);
      } else if (status.status === 'failed') {
        // ì‘ì—… ì‹¤íŒ¨
        setAiError(status.error_message || 'ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        setIsAiLoading(false);
        clearInterval(interval);
        setJobMonitoringInterval(null);
      }
      // ì§„í–‰ ì¤‘ì¸ ê²½ìš° ê³„ì† ëª¨ë‹ˆí„°ë§
    } catch (error) {
      console.error('ì‘ì—… ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
      // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê³„ì† ì‹œë„ (ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ)
    }
  }, 5000); // 5ì´ˆë§ˆë‹¤ í™•ì¸
  
  setJobMonitoringInterval(interval);
  
  // ìµœëŒ€ 30ë¶„ í›„ íƒ€ì„ì•„ì›ƒ
  setTimeout(() => {
    if (interval) {
      clearInterval(interval);
      setJobMonitoringInterval(null);
      setAiError('ì‘ì—… ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      setIsAiLoading(false);
    }
  }, 30 * 60 * 1000);
};

// ğŸ”¥ ì‘ì—… ì·¨ì†Œ í•¨ìˆ˜
const handleCancelAIJob = async () => {
  if (aiJobId) {
    try {
      await analysisService.cancelJob(aiJobId);
      setIsAiLoading(false);
      setAiResults(null);
      setAiJobId(null);
      if (jobMonitoringInterval) {
        clearInterval(jobMonitoringInterval);
        setJobMonitoringInterval(null);
      }
      alert('AI ë¶„ì„ ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
      console.error('ì‘ì—… ì·¨ì†Œ ì‹¤íŒ¨:', error);
      alert('ì‘ì—… ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  }
};

// ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì •ë¦¬
React.useEffect(() => {
  return () => {
    if (jobMonitoringInterval) {
      clearInterval(jobMonitoringInterval);
    }
  };
}, [jobMonitoringInterval]);

  const handleRetryAIRemediation = () => {
    setShowAiRemediation(false);
    setAiResults(null);
    setAiError(null);
    setTimeout(() => {
      handleGetAIRemediation();
    }, 500);
  };

  const getFrameworkInfo = frameworkId =>
    analysisService.getFrameworkInfo(frameworkId);

  const severityColors = {
    ê³ ìœ„í—˜: 'bg-red-100 text-red-800 border-red-200',
    ì¤‘ìœ„í—˜: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    ì €ìœ„í—˜: 'bg-blue-100 text-blue-800 border-blue-200',
    Critical: 'bg-red-200 text-red-900 border-red-300',
    High: 'bg-red-100 text-red-800 border-red-200',
    Medium: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    Low: 'bg-blue-100 text-blue-800 border-blue-200',
    ìƒ: 'bg-red-100 text-red-800 border-red-200',
    ì¤‘: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    í•˜: 'bg-blue-100 text-blue-800 border-blue-200',
  };

  const severityIcons = {
    ê³ ìœ„í—˜: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
    ),
    ì¤‘ìœ„í—˜: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    ì €ìœ„í—˜: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    Critical: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
    ),
    High: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
    ),
    Medium: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    Low: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    ìƒ: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
    ),
    ì¤‘: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    í•˜: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
  };

  // ì‹¬ê°ë„ í‘œì‹œë¥¼ ìœ„í•œ ë³€í™˜
  const getSeverityDisplay = severity => {
    const mapping = {
      High: 'ê³ ìœ„í—˜',
      Medium: 'ì¤‘ìœ„í—˜',
      Low: 'ì €ìœ„í—˜',
      Critical: 'ìµœê³ ìœ„í—˜',
      ìƒ: 'ê³ ìœ„í—˜',
      ì¤‘: 'ì¤‘ìœ„í—˜',
      í•˜: 'ì €ìœ„í—˜',
    };
    return mapping[severity] || severity;
  };

  // ì¹´í…Œê³ ë¦¬ í‘œì‹œë¥¼ ìœ„í•œ ë³€í™˜
  const getCategoryDisplay = category => {
    const mapping = {
      Authentication: 'ì¸ì¦',
      'Access Control': 'ì ‘ê·¼ ì œì–´',
      'Function Management': 'ê¸°ëŠ¥ ê´€ë¦¬',
      'Log Management': 'ë¡œê·¸ ê´€ë¦¬',
      'Patch Management': 'íŒ¨ì¹˜ ê´€ë¦¬',
      'Asset Management': 'ìì‚° ê´€ë¦¬',
      Configuration: 'ì„¤ì • ê´€ë¦¬',
      'ê³„ì • ê´€ë¦¬': 'ê³„ì • ê´€ë¦¬',
      'ì ‘ê·¼ ê´€ë¦¬': 'ì ‘ê·¼ ê´€ë¦¬',
      'ê¸°ëŠ¥ ê´€ë¦¬': 'ê¸°ëŠ¥ ê´€ë¦¬',
      'ë¡œê·¸ ê´€ë¦¬': 'ë¡œê·¸ ê´€ë¦¬',
      'íŒ¨ì¹˜ ê´€ë¦¬': 'íŒ¨ì¹˜ ê´€ë¦¬',
    };
    return mapping[category] || category;
  };

  const handleExportReport = () => {
    const reportData = {
      type: viewMode === 'comparison' ? 'comparison' : 'single',
      timestamp: new Date().toISOString(),
      ...(viewMode === 'comparison'
        ? {
            comparisonResults,
            summary: comparisonResults.summary,
          }
        : {
            results: currentResults,
            framework: currentResults?.metadata?.framework,
            summary: currentResults?.summary,
          }),
      exportTime: new Date().toISOString(),
      engineVersion:
        currentResults?.metadata?.engineVersion || 'Multi-Framework 1.0',
    };

    const dataStr = JSON.stringify(reportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    const filename =
      viewMode === 'comparison'
        ? `security-comparison-report-${new Date().toISOString().split('T')[0]}.json`
        : `security-analysis-report-${currentResults?.metadata?.framework || 'unknown'}-${new Date().toISOString().split('T')[0]}.json`;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
  };

  // ë¡œë”© ìƒíƒœ
  if (isAnalyzing) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
          <h3 className="text-lg font-medium text-gray-900 mb-2">
            ì„¤ì • íŒŒì¼ ë¶„ì„ ì¤‘...
          </h3>
          <p className="text-gray-500">
            {comparisonResults
              ? 'ë‹¤ì¤‘ ì§€ì¹¨ì„œ ë¹„êµ ë¶„ì„ì„'
              : `${selectedFramework} ë³´ì•ˆ ë£°ì…‹ì„`}{' '}
            ì ìš©í•˜ì—¬ ì·¨ì•½ì ì„ íƒì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤
          </p>
          <div className="mt-4 text-sm text-gray-400">
            <p>í‰ê·  ë¶„ì„ ì‹œê°„: 10-30ì´ˆ</p>
            {selectedFramework === 'NW' && (
              <p className="text-blue-500">NW ì§€ì¹¨ì„œëŠ” 42ê°œ ë£°ì„ ê²€ì‚¬í•©ë‹ˆë‹¤</p>
            )}
          </div>
        </div>
      </div>
    );
  }

  // ì—ëŸ¬ ìƒíƒœ
  if (error) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">ë¶„ì„ ê²°ê³¼</h1>
          <p className="text-gray-600">
            ë³´ì•ˆ ì·¨ì•½ì  ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤
          </p>
        </div>

        <div className="flex items-center justify-center h-96">
          <div className="text-center max-w-md">
            <svg
              className="w-16 h-16 text-red-400 mx-auto mb-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"
              />
            </svg>
            <h3 className="text-lg font-medium text-gray-900 mb-2">
              ë¶„ì„ ì‹¤íŒ¨
            </h3>
            <p className="text-gray-500 mb-6">{error}</p>
            <div className="flex space-x-3 justify-center">
              <button
                onClick={onRetry}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
              >
                ë‹¤ì‹œ ì‹œë„
              </button>
              <button
                onClick={onReset}
                className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200"
              >
                ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ê²°ê³¼ ì—†ìŒ
  if (!results && !comparisonResults) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <svg
            className="w-16 h-16 text-gray-400 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            />
          </svg>
          <h3 className="text-lg font-medium text-gray-900 mb-2">
            ë¶„ì„ ê²°ê³¼ ì—†ìŒ
          </h3>
          <p className="text-gray-500">
            ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼ë¥¼ ë³´ë ¤ë©´ ì„¤ì • íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Page Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">
            {isHistorical ? 'ë¶„ì„ ê¸°ë¡ ìƒì„¸ë³´ê¸°' : 'ë¶„ì„ ê²°ê³¼'}
          </h1>
          <p className="text-gray-600">
            {isHistorical && (
              <span className="inline-flex items-center px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full mr-2">
                <svg className="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ì €ì¥ëœ ê¸°ë¡
              </span>
            )}
            {viewMode === 'comparison'
              ? 'ë‹¤ì¤‘ ì§€ì¹¨ì„œ ë¹„êµ ë¶„ì„ ê²°ê³¼'
              : `${currentResults?.metadata?.framework || selectedFramework} ë³´ì•ˆ ë¶„ì„ ê²°ê³¼`}
            {currentResults?.metadata && (
              <span className="text-sm text-gray-500 ml-2">
                ({currentResults.metadata.deviceType} â€¢{' '}
                {currentResults.metadata.totalLines}ì¤„ â€¢
                {currentResults.metadata.analysisTime?.toFixed(2)}ì´ˆ ì†Œìš”)
              </span>
            )}
            {isHistorical && currentResults?.fileName && (
              <span className="text-sm text-gray-500 ml-2">
                â€¢ íŒŒì¼: {currentResults.fileName}
              </span>
            )}
          </p>
        </div>
        <div className="flex space-x-3">
          {/* AI ì¡°ì¹˜ ë°©ì•ˆ ë²„íŠ¼ - ë‹¨ì¼ ë²„íŠ¼ìœ¼ë¡œ í†µí•© */}
{currentResults && currentResults.vulnerabilities?.length > 0 && !isHistorical && (
  <div className="relative">
    <button
      onClick={handleGetAIRemediation}
      disabled={isAiLoading || loadingUsageInfo}
      className="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all duration-200 disabled:opacity-50 relative"
    >
      {isAiLoading ? (
        <>
          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white inline mr-2"></div>
          {currentResults.vulnerabilities.length >= 10 ? 'Enterprise ë¶„ì„ ì¤‘...' : 'AI ë¶„ì„ ì¤‘...'}
        </>
      ) : loadingUsageInfo ? (
        <>
          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white inline mr-2"></div>
          ì‚¬ìš©ëŸ‰ í™•ì¸ ì¤‘...
        </>
      ) : (
        <>
          <svg
            className="w-4 h-4 inline mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
            />
          </svg>
          {currentResults.vulnerabilities.length >= 10 ? 'AI ì¡°ì¹˜ ë°©ì•ˆ ìƒì„±' : 'AI ì¡°ì¹˜ ë°©ì•ˆ ìƒì„±'}
        </>
      )}
    </button>
    
    {/* ì²˜ë¦¬ ë°©ì‹ ì•ˆë‚´ */}
    {currentResults.vulnerabilities.length >= 10 && !isAiLoading && (
      <div className="absolute -top-8 left-0 right-0 text-center">
        <span className="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700">
          ğŸš€ ëŒ€ìš©ëŸ‰ ëª¨ë“œ ({currentResults.vulnerabilities.length}ê°œ ì·¨ì•½ì )
        </span>
      </div>
    )}
    
    {/* ì‘ì—… ì·¨ì†Œ ë²„íŠ¼ (ë¹„ë™ê¸° ì‘ì—… ì¤‘ì¼ ë•Œë§Œ) */}
    {isAiLoading && aiJobId && (
      <button
        onClick={handleCancelAIJob}
        className="absolute -right-20 top-0 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200"
      >
        <svg className="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
        ì·¨ì†Œ
      </button>
    )}
    
    {/* ì‚¬ìš©ëŸ‰ ì •ë³´ í‘œì‹œ (ê¸°ì¡´ê³¼ ë™ì¼) */}
    {user && aiUsageInfo && !isAiLoading && !loadingUsageInfo && (
  <div className="absolute -bottom-6 left-0 right-0 text-center">
    <span className={`text-xs px-2 py-1 rounded-full ${
      aiUsageInfo.isAdmin 
        ? 'bg-purple-100 text-purple-700'
        : aiUsageInfo.remainingUsage <= 2
          ? 'bg-red-100 text-red-700'
          : aiUsageInfo.remainingUsage <= 5
            ? 'bg-yellow-100 text-yellow-700'
            : 'bg-green-100 text-green-700'
    }`}>
      {aiUsageInfo.isAdmin 
        ? 'ê´€ë¦¬ì (ë¬´ì œí•œ)'
        : `ì˜¤ëŠ˜ ${aiUsageInfo.remainingUsage}íšŒ ë‚¨ìŒ`
      }
    </span>
  </div>
)}
  </div>
)}
          
          {/* ê¸°ì¡´ ë²„íŠ¼ë“¤ */}
          {isHistorical ? (
            <button
              onClick={onReset}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
            >
              <svg
                className="w-4 h-4 inline mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
              ìƒˆ ë¶„ì„ ì‹œì‘
            </button>
          ) : (
            <>
              <button
                onClick={handleExportReport}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
              >
                <svg
                  className="w-4 h-4 inline mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  />
                </svg>
                ë³´ê³ ì„œ ë‚´ë³´ë‚´ê¸°
              </button>
              <button
                onClick={onReset}
                className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200"
              >
                <svg
                  className="w-4 h-4 inline mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                  />
                </svg>
                ìƒˆ ë¶„ì„ ì‹œì‘
              </button>
            </>
          )}
        </div>
      </div>

      {/* Framework Selection for Comparison Mode */}
      {viewMode === 'comparison' && comparisonResults && (
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <h3 className="text-sm font-medium text-gray-900 mb-3">
            ë¹„êµ ì§€ì¹¨ì„œ ì„ íƒ
          </h3>
          <div className="flex flex-wrap gap-2">
            {Object.entries(comparisonResults.frameworks).map(
              ([frameworkId, result]) => {
                const info = getFrameworkInfo(frameworkId);
                const hasError = result.error;

                return (
                  <button
                    key={frameworkId}
                    onClick={() => setSelectedComparisonFramework(frameworkId)}
                    className={`px-3 py-2 text-sm font-medium rounded-lg border transition-colors duration-200 ${
                      selectedComparisonFramework === frameworkId
                        ? 'border-blue-500 bg-blue-50 text-blue-700'
                        : hasError
                          ? 'border-red-300 bg-red-50 text-red-600'
                          : 'border-gray-300 bg-white text-gray-700 hover:border-gray-400'
                    } ${hasError ? 'cursor-not-allowed' : 'cursor-pointer'}`}
                    disabled={hasError}
                  >
                    <div className="flex items-center space-x-2">
                      {info && (
                        <span
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: info.color }}
                        />
                      )}
                      <span>{frameworkId}</span>
                      {!hasError && result.issuesFound !== undefined && (
                        <span className="text-xs">
                          ({result.issuesFound}ê°œ)
                        </span>
                      )}
                      {hasError && (
                        <svg
                          className="w-4 h-4 text-red-500"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"
                          />
                        </svg>
                      )}
                    </div>
                  </button>
                );
              }
            )}
          </div>

          {/* Comparison Summary */}
          <div className="mt-4 p-3 bg-gray-50 rounded-lg">
            <div className="grid grid-cols-4 gap-4 text-sm">
              <div>
                <span className="text-gray-600">ë¶„ì„ëœ ì§€ì¹¨ì„œ:</span>
                <span className="ml-1 font-medium">
                  {Object.keys(comparisonResults.frameworks).length}ê°œ
                </span>
              </div>
              <div>
                <span className="text-gray-600">ì„±ê³µí•œ ë¶„ì„:</span>
                <span className="ml-1 font-medium text-green-600">
                  {
                    Object.values(comparisonResults.frameworks).filter(
                      r => !r.error
                    ).length
                  }
                  ê°œ
                </span>
              </div>
              <div>
                <span className="text-gray-600">ì´ ë°œê²¬ ì·¨ì•½ì :</span>
                <span className="ml-1 font-medium text-red-600">
                  {Object.values(comparisonResults.frameworks)
                    .filter(r => !r.error)
                    .reduce(
                      (sum, r) =>
                        sum +
                        (r.summary?.vulnerabilities || r.issuesFound || 0),
                      0
                    )}
                  ê°œ
                </span>
              </div>
              <div>
                <span className="text-gray-600">í‰ê·  ë³´ì•ˆ ì ìˆ˜:</span>
                <span className="ml-1 font-medium text-blue-600">
                  {Math.round(
                    Object.values(comparisonResults.frameworks)
                      .filter(r => !r.error)
                      .reduce((sum, r) => {
                        const total =
                          r.summary?.totalChecks ||
                          r.statistics?.totalRulesChecked ||
                          1;
                        const passed =
                          r.summary?.passed || r.statistics?.rulesPassed || 0;
                        return sum + (passed / total) * 100;
                      }, 0) /
                      Object.values(comparisonResults.frameworks).filter(
                        r => !r.error
                      ).length
                  )}
                  ì 
                </span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Summary Cards */}
      {currentResults && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center">
              <div className="p-2 bg-blue-100 rounded-lg">
                <svg
                  className="w-6 h-6 text-blue-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                  />
                </svg>
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">
                  ì´ ê²€ì‚¬ í•­ëª©
                </p>
                <p className="text-2xl font-bold text-gray-900">
                  {currentResults.summary?.totalChecks ||
                    currentResults.statistics?.totalRulesChecked ||
                    0}
                </p>
                <div className="text-xs text-gray-500">
                  {currentResults.metadata?.framework || selectedFramework}{' '}
                  ì§€ì¹¨ì„œ
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center">
              <div className="p-2 bg-red-100 rounded-lg">
                <svg
                  className="w-6 h-6 text-red-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"
                  />
                </svg>
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">
                  ë°œê²¬ëœ ì·¨ì•½ì 
                </p>
                <p className="text-2xl font-bold text-red-600">
                  {currentResults.summary?.vulnerabilities ||
                    currentResults.issuesFound ||
                    0}
                </p>
                <div className="text-xs text-gray-500">
                  ê³ :{currentResults.summary?.highSeverity || 0} ì¤‘:
                  {currentResults.summary?.mediumSeverity || 0} ì €:
                  {currentResults.summary?.lowSeverity || 0}
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center">
              <div className="p-2 bg-yellow-100 rounded-lg">
                <svg
                  className="w-6 h-6 text-yellow-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">ë³´ì•ˆ ì ìˆ˜</p>
                <p className="text-2xl font-bold text-yellow-600">
                  {(() => {
                    const total =
                      currentResults.summary?.totalChecks ||
                      currentResults.statistics?.totalRulesChecked ||
                      1;
                    const passed =
                      currentResults.summary?.passed ||
                      currentResults.statistics?.rulesPassed ||
                      0;
                    return Math.round((passed / total) * 100);
                  })()}
                  ì 
                </p>
                <div className="text-xs text-gray-500">100ì  ë§Œì </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div className="flex items-center">
              <div className="p-2 bg-green-100 rounded-lg">
                <svg
                  className="w-6 h-6 text-green-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-600">í†µê³¼ í•­ëª©</p>
                <p className="text-2xl font-bold text-green-600">
                  {currentResults.summary?.passed ||
                    currentResults.statistics?.rulesPassed ||
                    0}
                </p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Compliance Dashboard - ì»´í”Œë¼ì´ì–¸ìŠ¤ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ */}
      {currentResults?.metadata?.complianceSummary && (
        <ComplianceDashboard 
          complianceSummary={{
            ...currentResults.metadata.complianceSummary,
            // ğŸ”¥ ë°ì´í„° ì•ˆì „ì„± ë³´ì¥
            severityBreakdown: currentResults.metadata.complianceSummary.severityBreakdown || {},
            categoryBreakdown: currentResults.metadata.complianceSummary.categoryBreakdown || {}
          }}
          frameworkInfo={getFrameworkInfo(currentResults.metadata.framework)}
        />
      )}

      {/* Analysis Metadata */}
      {currentResults?.metadata && (
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">
            ë¶„ì„ ìƒì„¸ ì •ë³´
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <div className="text-sm font-medium text-gray-900">ì¥ë¹„ íƒ€ì…</div>
              <div className="text-sm text-gray-600">
                {sanitizeText(currentResults.metadata.deviceType)}
              </div>
            </div>
            <div>
              <div className="text-sm font-medium text-gray-900">ì§€ì¹¨ì„œ</div>
              <div className="text-sm text-gray-600">
                {sanitizeText(currentResults.metadata.framework)}
              </div>
            </div>
            <div>
              <div className="text-sm font-medium text-gray-900">ì„¤ì • íŒŒì¼ í¬ê¸°</div>
              <div className="text-sm text-gray-600">
                {sanitizeText(currentResults.metadata.totalLines?.toString() || '0')}ì¤„
              </div>
            </div>
            <div>
              <div className="text-sm font-medium text-gray-900">ë¶„ì„ ì‹œê°„</div>
              <div className="text-sm text-gray-600">
                {sanitizeText(currentResults.metadata.analysisTime?.toFixed(2) || '0')}ì´ˆ
              </div>
            </div>
            <div>
              <div className="text-sm font-medium text-gray-900">ì—”ì§„ ë²„ì „</div>
              <div className="text-sm text-gray-600">
                {sanitizeText(currentResults.metadata.engineVersion)}
              </div>
            </div>
            <div>
              <div className="text-sm font-medium text-gray-900">ë¶„ì„ ì‹œê°</div>
              <div className="text-sm text-gray-600">
                {sanitizeText(new Date(currentResults.metadata.timestamp).toLocaleString('ko-KR'))}
              </div>
            </div>
          </div>

          {currentResults.metadata.contextInfo && (
            <div className="mt-4 pt-4 border-t border-gray-200">
              <div className="text-sm font-medium text-gray-900 mb-2">
                ì„¤ì • ì»¨í…ìŠ¤íŠ¸
              </div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span className="text-gray-600">ì¸í„°í˜ì´ìŠ¤:</span>
                  <span className="ml-1 font-medium">
                    {currentResults.metadata.contextInfo.totalInterfaces || 0}ê°œ
                  </span>
                </div>
                <div>
                  <span className="text-gray-600">í™œì„± ì¸í„°í˜ì´ìŠ¤:</span>
                  <span className="ml-1 font-medium">
                    {currentResults.metadata.contextInfo.activeInterfaces || 0}
                    ê°œ
                  </span>
                </div>
                <div>
                  <span className="text-gray-600">ì„¤ì •ëœ ì„œë¹„ìŠ¤:</span>
                  <span className="ml-1 font-medium">
                    {currentResults.metadata.contextInfo.configuredServices ||
                      0}
                    ê°œ
                  </span>
                </div>
                <div>
                  <span className="text-gray-600">ë³µì¡ë„:</span>
                  <span className="ml-1 font-medium">
                    {currentResults.metadata.contextInfo.configComplexity ||
                      'N/A'}
                  </span>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Results Tabs and Filter */}
      {currentResults && (
        <div className="bg-white rounded-lg shadow-sm border border-gray-200">
          {/* Tab Navigation */}
          <div className="border-b border-gray-200">
            <nav className="flex space-x-8 px-6">
              {(() => {
                const tabsData = getResultTabsData();
                
                return [
                  { 
                    id: 'failed', 
                    name: 'ì·¨ì•½ì ', 
                    count: tabsData.failed.length,
                    color: 'text-red-600',
                    bgColor: 'bg-red-100',
                    icon: (
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z" />
                      </svg>
                    )
                  },
                  { 
                    id: 'passed', 
                    name: 'í†µê³¼', 
                    count: tabsData.passed.length,
                    color: 'text-green-600',
                    bgColor: 'bg-green-100',
                    icon: (
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    )
                  },
                  { 
                    id: 'skipped', 
                    name: 'ê±´ë„ˆëœ€', 
                    count: tabsData.skipped.length,
                    color: 'text-gray-600',
                    bgColor: 'bg-gray-100',
                    icon: (
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 9l3 3m0 0l-3 3m0 0V9" />
                      </svg>
                    )
                  }
                ].filter(tab => 
                  tab.id === 'failed' || 
                  (tab.id === 'passed' && tabsData.passed.length > 0) || 
                  (tab.id === 'skipped' && tabsData.skipped.length > 0) 
                ).map((tab) => (
                  <button
                    key={tab.id}
                    onClick={() => setSelectedResultTab(tab.id)}
                    className={`py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2 ${
                      selectedResultTab === tab.id
                        ? 'border-blue-500 text-blue-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    {tab.icon}
                    <span>{tab.name}</span>
                    <span className={`inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none rounded-full ${
                      selectedResultTab === tab.id ? tab.bgColor : 'bg-gray-100'
                    } ${tab.color}`}>
                      {tab.count}
                    </span>
                  </button>
                ));
              })()}
            </nav>
          </div>

          {/* Compliance Summary - ì»´í”Œë¼ì´ì–¸ìŠ¤ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ */}
          {currentResults.metadata?.complianceSummary && (
            <div className="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-semibold text-gray-900">ë³´ì•ˆ ì¤€ìˆ˜ìœ¨</h3>
                  <p className="text-sm text-gray-600">
                    ì „ì²´ {currentResults.metadata.complianceSummary.totalRules}ê°œ ë£° ì¤‘ 
                    {currentResults.metadata.complianceSummary.passedRules}ê°œ í†µê³¼
                  </p>
                </div>
                <div className="text-right">
                  <div className="text-3xl font-bold text-blue-600">
                    {currentResults.metadata.complianceSummary.complianceRate}%
                  </div>
                  <div className="text-sm text-gray-500">ì¤€ìˆ˜ìœ¨</div>
                </div>
              </div>
              
              <div className="mt-4">
                <div className="flex justify-between text-sm text-gray-600 mb-1">
                  <span>ë³´ì•ˆ ì¤€ìˆ˜ í˜„í™©</span>
                  <span>{currentResults.metadata.complianceSummary.passedRules}/{currentResults.metadata.complianceSummary.totalRules}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full transition-all duration-500"
                    style={{ width: `${currentResults.metadata.complianceSummary.complianceRate}%` }}
                  ></div>
                </div>
              </div>
            </div>
          )}

          {/* Filter Controls */}
          <div className="px-6 py-4 border-b border-gray-200">
            <div className="flex items-center justify-between">
              <h3 className="text-lg font-semibold text-gray-900">
                {selectedResultTab === 'failed' && `ë°œê²¬ëœ ì·¨ì•½ì  (${filteredResults.length}ê°œ)`}
                {selectedResultTab === 'passed' && `í†µê³¼ëœ ë³´ì•ˆ í•­ëª© (${filteredResults.length}ê°œ)`}
                {selectedResultTab === 'skipped' && `ê±´ë„ˆë›´ í•­ëª© (${filteredResults.length}ê°œ)`}
                {viewMode === 'comparison' && selectedComparisonFramework && (
                  <span className="ml-2 text-sm font-normal text-gray-500">
                    - {selectedComparisonFramework} ì§€ì¹¨ì„œ
                  </span>
                )}
              </h3>
              <div className="flex space-x-2">
                {['ì „ì²´', 'ê³ ìœ„í—˜', 'ì¤‘ìœ„í—˜', 'ì €ìœ„í—˜'].map(severity => (
                  <button
                    key={severity}
                    onClick={() => setSelectedSeverity(severity)}
                    className={`px-3 py-1 text-sm font-medium rounded-full transition-colors duration-200 ${
                      selectedSeverity === severity
                        ? 'bg-blue-100 text-blue-800'
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                  >
                    {severity}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Results Content */}
          <div className="p-6">
            {filteredResults.length === 0 ? (
              <div className="text-center py-8">
                {selectedResultTab === 'failed' && (
                  <>
                    <svg
                      className="w-12 h-12 text-green-400 mx-auto mb-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <p className="text-gray-500">
                      {selectedSeverity === 'ì „ì²´'
                        ? 'ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í›Œë¥­í•œ ë³´ì•ˆ ì„¤ì •ì…ë‹ˆë‹¤!'
                        : `${selectedSeverity} ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.`}
                    </p>
                  </>
                )}
                {selectedResultTab === 'passed' && (
                  <>
                    <svg
                      className="w-12 h-12 text-blue-400 mx-auto mb-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <p className="text-gray-500">
                      í†µê³¼ëœ ë³´ì•ˆ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                  </>
                )}
                {selectedResultTab === 'skipped' && (
                  <>
                    <svg
                      className="w-12 h-12 text-gray-400 mx-auto mb-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M13 9l3 3m0 0l-3 3m0 0V9"
                      />
                    </svg>
                    <p className="text-gray-500">
                      ê±´ë„ˆë›´ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
                    </p>
                  </>
                )}
              </div>
            ) : (
              <div className="space-y-4">
                {filteredResults.map(item => (
                  <div
                    key={item.id}
                    className={`border rounded-lg ${
                      selectedResultTab === 'failed' ? 'border-red-200' :
                      selectedResultTab === 'passed' ? 'border-green-200' :
                      'border-gray-200'
                    }`}
                  >
                    <div
                      className={`p-4 cursor-pointer transition-colors duration-200 ${
                        selectedResultTab === 'failed' ? 'hover:bg-red-50' :
                        selectedResultTab === 'passed' ? 'hover:bg-green-50' :
                        'hover:bg-gray-50'
                      }`}
                      onClick={() =>
                        setExpandedCard(
                          expandedCard === item.id ? null : item.id
                        )
                      }
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                          <span
                            className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${
                              selectedResultTab === 'failed' ? 
                                (severityColors[item.severity] || severityColors[getSeverityDisplay(item.severity)]) :
                              selectedResultTab === 'passed' ?
                                'bg-green-100 text-green-800 border-green-200' :
                                'bg-gray-100 text-gray-800 border-gray-200'
                            }`}
                          >
                            {selectedResultTab === 'failed' && (
                              severityIcons[item.severity] || severityIcons[getSeverityDisplay(item.severity)]
                            )}
                            {selectedResultTab === 'passed' && (
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                              </svg>
                            )}
                            {selectedResultTab === 'skipped' && (
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 9l3 3m0 0l-3 3" />
                              </svg>
                            )}
                            <span className="ml-1">
                              {selectedResultTab === 'failed' && getSeverityDisplay(item.severity)}
                              {selectedResultTab === 'passed' && 'í†µê³¼'}
                              {selectedResultTab === 'skipped' && 'ê±´ë„ˆëœ€'}
                            </span>
                          </span>
                          <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            {getCategoryDisplay(item.type || item.typeKo)}
                          </span>
                          {item.ruleId && (
                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                              {item.ruleId}
                            </span>
                          )}
                          {item.framework && (
                            <span
                              className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                              style={{
                                backgroundColor:
                                  getFrameworkInfo(item.framework)?.color + '20',
                                color: getFrameworkInfo(item.framework)?.color,
                              }}
                            >
                              {item.framework}
                            </span>
                          )}
                        </div>
                        <svg
                          className={`w-5 h-5 text-gray-400 transition-transform duration-200 ${
                            expandedCard === item.id ? 'transform rotate-180' : ''
                          }`}
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M19 9l-7 7-7-7"
                          />
                        </svg>
                      </div>
                      <div className="mt-2">
                        <h4 className="text-sm font-medium text-gray-900">
                          {sanitizeText(item.description)}
                        </h4>
                        {item.line && (
                          <p className="text-xs text-gray-500 mt-1">
                            ë¼ì¸ {item.line}: {sanitizeText(item.matchedText)}
                          </p>
                        )}
                      </div>
                    </div>

                    {expandedCard === item.id && (
                      <div className={`px-4 pb-4 border-t ${
                        selectedResultTab === 'failed' ? 'border-red-100 bg-red-50' :
                        selectedResultTab === 'passed' ? 'border-green-100 bg-green-50' :
                        'border-gray-100 bg-gray-50'
                      }`}>
                        <div className="pt-4">
                          <h5 className="text-sm font-medium text-gray-900 mb-2">
                            {selectedResultTab === 'failed' && 'ê¶Œì¥ ì‚¬í•­:'}
                            {selectedResultTab === 'passed' && 'ì„¤ì • ìƒíƒœ:'}
                            {selectedResultTab === 'skipped' && 'ê±´ë„ˆë›´ ì´ìœ :'}
                          </h5>
                          <p className="text-sm text-gray-600 mb-4">
                            {selectedResultTab === 'failed' && sanitizeText(item.recommendation)}
                            {selectedResultTab === 'passed' && `ì´ ë³´ì•ˆ ì„¤ì •ì´ ì˜¬ë°”ë¥´ê²Œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ${item.recommendation || 'ì¶”ê°€ ì¡°ì¹˜ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}`}
                            {selectedResultTab === 'skipped' && (item.recommendation || 'ì´ ë£°ì€ í˜„ì¬ ì„¤ì •ì— ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')}
                          </p>

                          {item.reference && (
                            <div className="mb-4">
                              <h5 className="text-sm font-medium text-gray-900 mb-1">
                                ì°¸ê³  ìë£Œ:
                              </h5>
                              <p className="text-xs text-gray-500">
                                {sanitizeText(item.reference)}
                              </p>
                            </div>
                          )}
                          
                          <div className="flex space-x-3">
                            {selectedResultTab === 'failed' && (
                              <button className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors duration-200">
                                í•´ê²°ë¨ìœ¼ë¡œ í‘œì‹œ
                              </button>
                            )}
                            {selectedResultTab === 'passed' && (
                              <button className="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors duration-200">
                                ìš°ìˆ˜ ì„¤ì •ìœ¼ë¡œ í‘œì‹œ
                              </button>
                            )}
                            <button
                              onClick={() => {
                                const details = `${sanitizeText(item.ruleId || '')}: ${sanitizeText(item.description)}\nê¶Œì¥ì‚¬í•­: ${sanitizeText(item.recommendation)}\nì°¸ê³ : ${sanitizeText(item.reference || 'N/A')}`;
                                navigator.clipboard.writeText(details);
                              }}
                              className="px-3 py-1 border border-gray-300 text-gray-700 text-xs rounded hover:bg-gray-50 transition-colors duration-200"
                            >
                              ì„¸ë¶€ ì •ë³´ ë³µì‚¬
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* AI Remediation Modal */}
      {(showAiRemediation || isAiLoading) && (
        <AIRemediation
          aiResults={aiResults}
          isLoading={isAiLoading}
          onClose={() => {
            setShowAiRemediation(false);
            setAiResults(null);
          }}
          onRetry={handleRetryAIRemediation}
        />
      )}
    </div>
  );
};

export default VulnerabilityResults;