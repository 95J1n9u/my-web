rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // í—¬í¼ í•¨ìˆ˜ë“¤
    // ========================================
    
    // ì‚¬ìš©ìž ì¸ì¦ í™•ì¸
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // í˜„ìž¬ ì‚¬ìš©ìžì˜ UID
    function currentUserId() {
      return request.auth.uid;
    }
    
    // ê´€ë¦¬ìž ê¶Œí•œ í™•ì¸ (ì•ˆì „í•œ ë°©ì‹)
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // ì¤‘ê°„ ê´€ë¦¬ìž ì´ìƒ ê¶Œí•œ í™•ì¸ (ì•ˆì „í•œ ë°©ì‹)
    function isModerator() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'moderator'];
    }
    
    // ë°ì´í„° ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜ë“¤
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidRole(role) {
      return role in ['user', 'admin', 'moderator', 'premium'];
    }
    
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }
    
    // ========================================
    // ì‚¬ìš©ìž ì»¬ë ‰ì…˜ (/users/{userId})
    // ========================================
    match /users/{userId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ìž + íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ ì œí•œì  ì ‘ê·¼
      allow read: if isAuthenticated() || 
                  isPhoneDuplicateCheck();
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìžê°€ ë³¸ì¸ ê³„ì •ë§Œ ìƒì„± ê°€ëŠ¥
      allow create: if isAuthenticated() && 
                    currentUserId() == userId;
      
      // ìˆ˜ì •: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìž
      allow update: if isAuthenticated() && 
                    (currentUserId() == userId || isAdmin());
      
      // ì‚­ì œ: ê´€ë¦¬ìžë§Œ
      allow delete: if isAdmin();
      
      // ðŸ”¥ íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•œ íŠ¹ë³„ ê¶Œí•œ
      function isPhoneDuplicateCheck() {
        return request.auth == null && 
              request.query != null &&
              request.query.limit <= 1 &&
              resource.data.keys().hasOnly(['phoneNumber', 'uid', 'email', 'displayName', 'createdAt', 'role', 'emailVerified', 'phoneVerified', 'lastLoginAt', 'analysisCount', 'preferences', 'provider']);
      }
      
      // ì¼ë°˜ ì‚¬ìš©ìž ì—…ë°ì´íŠ¸ ê²€ì¦ (ë³¸ì¸ë§Œ)
      function isValidUserUpdate(data) {
        let allowedFields = ['displayName', 'photoURL', 'preferences', 'lastLoginAt', 'analysisCount', 'phoneNumber', 'phoneVerified', 'aiUsage', 'lastAIUsedAt'];
        return data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
      }
      
      // ê´€ë¦¬ìž ì—…ë°ì´íŠ¸ ê²€ì¦
      function isValidAdminUserUpdate(data) {
        return true; // ê´€ë¦¬ìžëŠ” ëª¨ë“  í•„ë“œ ìˆ˜ì • ê°€ëŠ¥
      }
      
      // ========================================
      // ë¶„ì„ ê²°ê³¼ ì„œë¸Œì»¬ë ‰ì…˜ (/users/{userId}/analyses/{analysisId})
      // ========================================
      match /analyses/{analysisId} {
        // ì½ê¸°: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìž
        allow read: if isAuthenticated() && 
                    (currentUserId() == userId || isAdmin());
        
        // ìƒì„±: ì¸ì¦ëœ ë³¸ì¸ë§Œ
        allow create: if isAuthenticated() && 
                      currentUserId() == userId &&
                      isValidAnalysisData(request.resource.data);
        
        // ìˆ˜ì •: ë³¸ì¸ë§Œ (ì œí•œëœ í•„ë“œ)
        allow update: if isAuthenticated() && 
                      currentUserId() == userId &&
                      isValidAnalysisUpdate(request.resource.data);
        
        // ì‚­ì œ: ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìž
        allow delete: if isAuthenticated() && 
                      (currentUserId() == userId || isAdmin());
        
        // ë¶„ì„ ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
        function isValidAnalysisData(data) {
          return data.keys().hasAll(['userId', 'timestamp', 'deviceType', 'framework']) &&
                 data.userId == userId;
        }
        
        // ë¶„ì„ ë°ì´í„° ì—…ë°ì´íŠ¸ ê²€ì¦
        function isValidAnalysisUpdate(data) {
          let allowedFields = ['notes', 'status', 'tags'];
          return data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
        }
      }
    }
    
    // ========================================
    // ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ ì»¬ë ‰ì…˜ (/posts/{postId})
    // ========================================
    match /posts/{postId} {
      // ì½ê¸°: ì™„ì „ížˆ ê³µê°œ - ëˆ„êµ¬ë‚˜ ëª¨ë“  ê²Œì‹œê¸€ ì½ê¸° ê°€ëŠ¥
      allow read: if true;
      
      // ë¦¬ìŠ¤íŠ¸ ì½ê¸°ë„ ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©
      allow list: if true;
      
      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìžë§Œ
      allow create: if isAuthenticated() && 
                    request.resource.data.authorId == currentUserId();
      
      // ìˆ˜ì •: ìž‘ì„±ìž ë³¸ì¸, ê´€ë¦¬ìž, ë˜ëŠ” ì¡°íšŒìˆ˜ ì¦ê°€
      allow update: if isAuthenticated() && (
                      (resource.data.authorId == currentUserId()) ||
                      (isAdmin()) ||
                      (
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']) &&
                        request.resource.data.views == resource.data.views + 1
                      )
                    );
      
      // ì‚­ì œ: ìž‘ì„±ìž ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìž
      allow delete: if isAuthenticated() && 
                    (resource.data.authorId == currentUserId() || isAdmin());
      
      // ëŒ“ê¸€ ì„œë¸Œì»¬ë ‰ì…˜
      match /comments/{commentId} {
        // ì½ê¸°: ëª¨ë“  ì‚¬ëžŒ í—ˆìš©
        allow read: if true;
        
        // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ìžë§Œ
        allow create: if isAuthenticated() && 
                      isValidCommentData(request.resource.data);
        
        // ìˆ˜ì •: ìž‘ì„±ìž ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìž
        allow update: if isAuthenticated() && 
                      (resource.data.authorId == currentUserId() || isAdmin());
        
        // ì‚­ì œ: ìž‘ì„±ìž ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìž
        allow delete: if isAuthenticated() && 
                      (resource.data.authorId == currentUserId() || isAdmin());
        
        // ëŒ“ê¸€ ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
        function isValidCommentData(data) {
          return data.keys().hasAll(['content', 'authorId', 'createdAt']) &&
                 isValidString(data.content, 1, 1000) &&
                 data.authorId == currentUserId();
        }
      }
    }
    
    // ========================================
    // ê³µì§€ì‚¬í•­ ì»¬ë ‰ì…˜ (/notices/{noticeId})
    // ========================================
    match /notices/{noticeId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ëžŒ í—ˆìš© (ê³µì§€ì‚¬í•­ê³¼ ë¦¬ìŠ¤íŠ¸ ì¿¼ë¦¬ ëª¨ë‘)
      allow read: if true;
      
      // ìƒì„±: ê´€ë¦¬ìžë§Œ
      allow create: if isAdmin() && isValidNoticeData(request.resource.data);
      
      // ìˆ˜ì •: ê´€ë¦¬ìž ë˜ëŠ” ì¡°íšŒìˆ˜ ì¦ê°€
      allow update: if isAuthenticated() && (
                      (isAdmin() && isValidNoticeUpdate(request.resource.data)) ||
                      (
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']) &&
                        request.resource.data.views == resource.data.views + 1
                      )
                    );
      
      // ì‚­ì œ: ê´€ë¦¬ìžë§Œ
      allow delete: if isAdmin();
      
      // ê³µì§€ì‚¬í•­ ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
      function isValidNoticeData(data) {
        let validCategories = ['general', 'maintenance', 'update', 'security', 'event'];
        let validPriorities = ['normal', 'high', 'urgent'];
        return data.keys().hasAll(['title', 'content', 'category', 'priority', 'authorId', 'createdAt', 'isPublished']) &&
               isValidString(data.title, 1, 200) &&
               isValidString(data.content, 1, 10000) &&
               data.category in validCategories &&
               data.priority in validPriorities &&
               data.authorId == currentUserId() &&
               data.isPublished == true;
      }
      
      // ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸ ê²€ì¦
      function isValidNoticeUpdate(data) {
        let allowedFields = ['title', 'content', 'category', 'priority', 'isPinned', 'expiresAt', 'updatedAt', 'updatedBy', 'views'];
        return data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
      }
    }
    
    // ========================================
    // ì‹œìŠ¤í…œ ì„¤ì • ì»¬ë ‰ì…˜ (/system/{configId})
    // ========================================
    match /system/{configId} {
      // ì½ê¸°: ê´€ë¦¬ìžë§Œ
      allow read: if isAdmin();
      
      // ì“°ê¸°: ê´€ë¦¬ìžë§Œ
      allow write: if isAdmin();
    }
    
    // ========================================
    // ì‹œìŠ¤í…œ í†µê³„ ì»¬ë ‰ì…˜ (/stats/{statId})
    // ========================================
    match /stats/{statId} {
      // ì½ê¸°: ê´€ë¦¬ìžë§Œ
      allow read: if isAdmin();
      
      // ì“°ê¸°: ê´€ë¦¬ìžë§Œ
      allow write: if isAdmin();
    }
    
    // ========================================
    // ê¸°ë³¸ ê±°ë¶€ ê·œì¹™ (ëª…ì‹œë˜ì§€ ì•Šì€ ëª¨ë“  ì»¬ë ‰ì…˜/ë¬¸ì„œ)
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}